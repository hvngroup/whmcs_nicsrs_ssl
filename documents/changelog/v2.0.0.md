# NicSRS SSL Server Module Upgrade Plan v2.0.0

## Project Overview

| Item | Details |
|------|---------|
| **Project** | NicSRS SSL Server Provisioning Module Upgrade |
| **Current Version** | 1.x (nicsrs_ssl_old) |
| **Target Version** | 2.0.0 |
| **Type** | WHMCS Server Provisioning Module |
| **Author** | HVN GROUP |
| **Estimated Duration** | 3-4 weeks |
| **Start Date** | TBD |

---

## Executive Summary

This plan outlines the upgrade of the NicSRS SSL Server Provisioning Module from its current outdated UI to a modern interface consistent with the NicSRS SSL Admin Addon Module. The upgrade prioritizes:

1. **UI Modernization** - Ant Design-inspired styling matching the Admin Addon
2. **Minimal Structure Changes** - Preserve existing architecture for backward compatibility
3. **API Integration** - Leverage shared API configuration from Admin Addon
4. **Enhanced Client Actions** - Add manage, reissue, renew actions in client area
5. **Vendor Privacy** - Remove "NicSRS" branding from public-facing assets

---

## Current State Analysis

### Existing Module Structure
```
modules/servers/nicsrs_ssl_old/
├── nicsrs_ssl.php                    # Main entry point ✓ Keep
├── hooks.php                         # WHMCS hooks ✓ Keep
│
├── lang/
│   ├── english.php                   # ✓ Enhance
│   ├── vietnamese.php                # + Add
│   ├── chinese.php                   # ✓ Keep
│   └── chinese-cn.php                # ✓ Keep
│
├── src/
│   ├── config/
│   │   ├── const.php                 # ✓ Keep
│   │   └── country.json              # ✓ Keep
│   │
│   └── model/
│       ├── Controller/
│       │   ├── PageController.php    # ✓ Modify (minimal)
│       │   └── ActionController.php  # ✓ Enhance (add actions)
│       │
│       ├── Dispatcher/
│       │   ├── PageDispatcher.php    # ✓ Keep
│       │   └── ActionDispatcher.php  # ✓ Enhance (new routes)
│       │
│       └── Service/
│           ├── nicsrsAPI.php         # ✓ Modify (shared API key)
│           ├── nicsrsFunc.php        # ✓ Keep
│           ├── nicsrsResponse.php    # ✓ Keep
│           ├── nicsrsSSLSql.php      # ✓ Keep
│           └── nicsrsTemplate.php    # ✓ Modify (new templates)
│
└── view/
    ├── applycert.tpl                 # ★ Complete Redesign
    ├── complete.tpl                  # ★ Complete Redesign
    ├── message.tpl                   # ★ Complete Redesign
    ├── replace.tpl                   # ★ Complete Redesign
    ├── replace1.tpl                  # ★ Complete Redesign
    ├── error.tpl                     # ★ Complete Redesign
    └── home/                         # ★ Rename & Redesign
        ├── css/
        │   └── nicsrs-client.css     # Rebrand to ssl-manager.css
        └── js/
            └── nicsrs-client.js      # Rebrand to ssl-manager.js
```

### What Works Well (Keep)
- MVC architecture pattern
- Database schema (nicsrs_sslorders)
- API integration logic
- Certificate status state machine
- Multi-language support framework

### What Needs Upgrade
- **UI/UX**: Outdated styling, inconsistent with Admin Addon
- **Branding**: "NicSRS" visible in public CSS/JS class names
- **API Key**: Per-product API key (should use shared from Admin Addon)
- **Actions**: Missing manage, reissue, renew in client area
- **CSR Form**: Should default to auto-generate CSR option

---

## Target Architecture

### New Directory Structure
```
modules/servers/nicsrs_ssl/
├── nicsrs_ssl.php                    # Main entry point (enhanced)
├── hooks.php                         # WHMCS hooks (enhanced)
│
├── lang/
│   ├── english.php                   # Enhanced language strings
│   ├── vietnamese.php                # New Vietnamese translations
│   ├── chinese.php                   # Traditional Chinese
│   └── chinese-cn.php                # Simplified Chinese
│
├── src/
│   ├── config/
│   │   ├── const.php                 # Constants (enhanced)
│   │   └── country.json              # Country list
│   │
│   └── model/
│       ├── Controller/
│       │   ├── PageController.php    # Page rendering (enhanced)
│       │   └── ActionController.php  # Actions (new: manage, reissue)
│       │
│       ├── Dispatcher/
│       │   ├── PageDispatcher.php    # Page routing
│       │   └── ActionDispatcher.php  # Action routing (new routes)
│       │
│       └── Service/
│           ├── ApiService.php        # Renamed, shared API key support
│           ├── CertificateFunc.php   # Renamed from nicsrsFunc
│           ├── ResponseFormatter.php # Renamed from nicsrsResponse
│           ├── OrderRepository.php   # Renamed from nicsrsSSLSql
│           └── TemplateHelper.php    # Renamed from nicsrsTemplate
│
├── view/
│   ├── applycert.tpl                 # Modern certificate application
│   ├── complete.tpl                  # Modern completed view
│   ├── message.tpl                   # Modern status messages
│   ├── pending.tpl                   # New: Pending status view
│   ├── manage.tpl                    # New: Management dashboard
│   ├── reissue.tpl                   # Modern reissue form
│   ├── error.tpl                     # Modern error display
│   └── partials/
│       ├── header.tpl                # Shared header component
│       ├── footer.tpl                # Shared footer component
│       ├── dcv-status.tpl            # DCV status component
│       └── cert-actions.tpl          # Action buttons component
│
└── assets/                           # Renamed from view/home
    ├── css/
    │   └── ssl-manager.css           # Ant Design-inspired styles
    └── js/
        ├── ssl-manager.js            # Main JavaScript
        ├── csr-generator.js          # CSR auto-generation
        └── form-validator.js         # Form validation
```

---

## Phase 1: Foundation & API Integration (Week 1)

### 1.1 Shared API Configuration

**Objective**: Use API token from Admin Addon settings instead of per-product configuration.

**Changes to nicsrs_ssl.php**:
```php
function nicsrs_ssl_ConfigOptions() {
    return [
        'cert_type' => [
            'FriendlyName' => 'Certificate Type',
            'Type' => 'dropdown',
            'Options' => CertificateFunc::getCertAttributes(null, 'name'),
        ],
        'api_token' => [
            'FriendlyName' => 'API Token',
            'Type' => 'password',
            'size' => '32',
            'Description' => 'Leave empty to use shared API token from Admin Addon',
        ],
    ];
}
```

**New ApiService.php** (replaces nicsrsAPI.php):
```php
<?php
namespace nicsrsSSL;

use WHMCS\Database\Capsule;

class ApiService {
    private const API_BASE = 'https://portal.nicsrs.com/ssl';
    
    /**
     * Get API token with fallback to Admin Addon settings
     */
    public static function getApiToken(array $params = []): string
    {
        // 1. Check product-level API token first
        if (!empty($params['configoption2'])) {
            return $params['configoption2'];
        }
        
        // 2. Fallback to Admin Addon shared settings
        $setting = Capsule::table('mod_nicsrs_settings')
            ->where('setting_key', 'api_token')
            ->first();
            
        if ($setting && !empty($setting->setting_value)) {
            return $setting->setting_value;
        }
        
        throw new \Exception('API token not configured');
    }
    
    // ... existing methods with token fallback
}
```

### 1.2 Service Layer Refactoring

| Old File | New File | Changes |
|----------|----------|---------|
| nicsrsAPI.php | ApiService.php | Add shared API key support |
| nicsrsFunc.php | CertificateFunc.php | Rename, add CSR generation |
| nicsrsResponse.php | ResponseFormatter.php | Rename only |
| nicsrsSSLSql.php | OrderRepository.php | Rename only |
| nicsrsTemplate.php | TemplateHelper.php | Rename, add partials support |

### 1.3 Language Files Enhancement

**Add Vietnamese (vietnamese.php)**:
```php
<?php
$_LANG['ssl_management'] = 'Quản lý SSL';
$_LANG['configure_certificate'] = 'Cấu hình Chứng chỉ';
$_LANG['auto_generate_csr'] = 'Tự động tạo CSR';
$_LANG['manual_csr'] = 'Nhập CSR thủ công';
// ... full translations
```

### Tasks - Phase 1:
- [ ] 1.1.1 Create ApiService.php with shared API key fallback
- [ ] 1.1.2 Update nicsrs_ssl.php ConfigOptions
- [ ] 1.2.1 Rename service files (preserve backward compatibility aliases)
- [ ] 1.2.2 Add CSR auto-generation to CertificateFunc
- [ ] 1.3.1 Complete vietnamese.php translation
- [ ] 1.3.2 Enhance english.php with new strings

---

## Phase 2: UI Modernization - CSS Framework (Week 1-2)

### 2.1 Design System (Matching Admin Addon)

**Color Palette** (from ADMIN-ADDON-SPEC.md):
```css
:root {
    /* Primary Colors */
    --ssl-primary: #1890ff;
    --ssl-success: #52c41a;
    --ssl-warning: #faad14;
    --ssl-error: #ff4d4f;
    --ssl-info: #1890ff;
    
    /* Neutral Colors */
    --ssl-heading: #262626;
    --ssl-text: #595959;
    --ssl-text-secondary: #8c8c8c;
    --ssl-border: #d9d9d9;
    --ssl-background: #f5f5f5;
    --ssl-component-bg: #ffffff;
    
    /* Status Badge Colors */
    --ssl-badge-complete: #52c41a;
    --ssl-badge-pending: #faad14;
    --ssl-badge-cancelled: #ff4d4f;
    --ssl-badge-draft: #8c8c8c;
    --ssl-badge-reissue: #722ed1;
}
```

### 2.2 Asset Rebranding

**Old → New Naming Convention**:
| Old | New | Reason |
|-----|-----|--------|
| `view/home/` | `assets/` | Standard naming |
| `nicsrs-*.css` | `ssl-manager.css` | Remove vendor name |
| `nicsrs-*.js` | `ssl-manager.js` | Remove vendor name |
| `.nicsrs-*` classes | `.sslm-*` classes | Generic prefix |

**New CSS Structure** (ssl-manager.css):
```css
/* SSL Manager - Client Area Styles */
/* Vendor-neutral naming - NO "NicSRS" references */

/* Base Layout */
.sslm-container { ... }
.sslm-card { ... }
.sslm-form { ... }

/* Status Badges */
.sslm-badge { ... }
.sslm-badge--complete { ... }
.sslm-badge--pending { ... }
.sslm-badge--cancelled { ... }

/* Form Elements */
.sslm-input { ... }
.sslm-select { ... }
.sslm-textarea { ... }
.sslm-btn { ... }
.sslm-btn--primary { ... }

/* Components */
.sslm-dcv-table { ... }
.sslm-cert-info { ... }
.sslm-action-bar { ... }
```

### Tasks - Phase 2:
- [ ] 2.1.1 Create ssl-manager.css with Ant Design styling
- [ ] 2.1.2 Create CSS variables for theming
- [ ] 2.2.1 Rename all CSS classes from nicsrs-* to sslm-*
- [ ] 2.2.2 Create ssl-manager.js with vanilla JS (no jQuery dependency)
- [ ] 2.2.3 Create form-validator.js for client-side validation
- [ ] 2.2.4 Create csr-generator.js for auto CSR generation

---

## Phase 3: Template Redesign (Week 2-3)

### 3.1 ApplyCert Template (★ Priority)

**Key Requirements**:
1. **Default to Auto-Generate CSR** (as per requirement)
2. Modern card-based layout
3. Progressive form steps
4. Real-time validation

**New applycert.tpl Structure**:
```html
<div class="sslm-container">
    <!-- Progress Steps -->
    <div class="sslm-steps">
        <div class="sslm-step sslm-step--active" data-step="1">
            <span class="sslm-step__number">1</span>
            <span class="sslm-step__title">{$_LANG.step_csr}</span>
        </div>
        <div class="sslm-step" data-step="2">...</div>
        <div class="sslm-step" data-step="3">...</div>
    </div>
    
    <!-- Step 1: CSR Section -->
    <div class="sslm-card" id="step-csr">
        <div class="sslm-card__header">
            <h3>{$_LANG.csr_configuration}</h3>
        </div>
        <div class="sslm-card__body">
            <!-- CSR Mode Toggle - Default: Auto Generate -->
            <div class="sslm-radio-group">
                <label class="sslm-radio sslm-radio--checked">
                    <input type="radio" name="csrMode" value="auto" checked>
                    <span>{$_LANG.auto_generate_csr}</span>
                </label>
                <label class="sslm-radio">
                    <input type="radio" name="csrMode" value="manual">
                    <span>{$_LANG.manual_csr}</span>
                </label>
            </div>
            
            <!-- Auto CSR Fields (shown by default) -->
            <div id="autoCSRFields" class="sslm-form-section">
                <div class="sslm-form-row">
                    <div class="sslm-form-group">
                        <label>{$_LANG.common_name}</label>
                        <input type="text" name="cn" class="sslm-input" required>
                    </div>
                    <div class="sslm-form-group">
                        <label>{$_LANG.organization}</label>
                        <input type="text" name="org" class="sslm-input">
                    </div>
                </div>
                <!-- More fields -->
            </div>
            
            <!-- Manual CSR Textarea (hidden by default) -->
            <div id="manualCSRField" class="sslm-form-section" style="display:none">
                <textarea name="csr" class="sslm-textarea sslm-textarea--code"></textarea>
            </div>
        </div>
    </div>
    
    <!-- Step 2: Domain Validation -->
    <div class="sslm-card" id="step-domain">...</div>
    
    <!-- Step 3: Contact Information -->
    <div class="sslm-card" id="step-contacts">...</div>
    
    <!-- Submit Button -->
    <div class="sslm-action-bar">
        <button type="button" class="sslm-btn sslm-btn--secondary" id="btnSaveDraft">
            {$_LANG.save_draft}
        </button>
        <button type="submit" class="sslm-btn sslm-btn--primary" id="btnSubmit">
            {$_LANG.submit_request}
        </button>
    </div>
</div>
```

### 3.2 Complete Template

**New complete.tpl with Action Buttons**:
```html
<div class="sslm-container">
    <!-- Certificate Status Card -->
    <div class="sslm-card sslm-card--success">
        <div class="sslm-card__header">
            <h3><i class="sslm-icon sslm-icon--check"></i> {$_LANG.certificate_issued}</h3>
            <span class="sslm-badge sslm-badge--complete">{$status}</span>
        </div>
        <div class="sslm-card__body">
            <div class="sslm-cert-info">
                <div class="sslm-cert-info__item">
                    <label>{$_LANG.cert_begin}</label>
                    <span>{$begin_date}</span>
                </div>
                <div class="sslm-cert-info__item">
                    <label>{$_LANG.cert_end}</label>
                    <span>{$end_date}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="sslm-action-bar sslm-action-bar--centered">
        <button class="sslm-btn sslm-btn--primary" onclick="downloadCertificate()">
            <i class="sslm-icon sslm-icon--download"></i> {$_LANG.download_certificate}
        </button>
        <button class="sslm-btn sslm-btn--secondary" onclick="reissueCertificate()">
            <i class="sslm-icon sslm-icon--refresh"></i> {$_LANG.reissue}
        </button>
        <button class="sslm-btn sslm-btn--secondary" onclick="renewCertificate()">
            <i class="sslm-icon sslm-icon--calendar"></i> {$_LANG.renew}
        </button>
    </div>
    
    <!-- Domain Validation Status -->
    {include file="partials/dcv-status.tpl"}
</div>
```

### 3.3 New Manage Template

**manage.tpl** - Dashboard for certificate management:
```html
<div class="sslm-container">
    <!-- Certificate Overview -->
    <div class="sslm-card">
        <div class="sslm-card__header">
            <h3>{$_LANG.certificate_management}</h3>
            <button class="sslm-btn sslm-btn--sm" onclick="refreshStatus()">
                <i class="sslm-icon sslm-icon--sync"></i> {$_LANG.refresh}
            </button>
        </div>
        <div class="sslm-card__body">
            <!-- Certificate Details -->
            <table class="sslm-table">
                <tr>
                    <th>{$_LANG.domain}</th>
                    <td>{$domain}</td>
                </tr>
                <tr>
                    <th>{$_LANG.product}</th>
                    <td>{$productCode}</td>
                </tr>
                <tr>
                    <th>{$_LANG.status}</th>
                    <td><span class="sslm-badge sslm-badge--{$statusClass}">{$status}</span></td>
                </tr>
                <tr>
                    <th>{$_LANG.expires}</th>
                    <td>{$end_date}</td>
                </tr>
            </table>
        </div>
    </div>
    
    <!-- Available Actions -->
    <div class="sslm-card">
        <div class="sslm-card__header">
            <h3>{$_LANG.actions}</h3>
        </div>
        <div class="sslm-card__body">
            <div class="sslm-action-grid">
                {if $canDownload}
                <div class="sslm-action-item" onclick="downloadCertificate()">
                    <i class="sslm-icon sslm-icon--download"></i>
                    <span>{$_LANG.download}</span>
                </div>
                {/if}
                {if $canReissue}
                <div class="sslm-action-item" onclick="reissueCertificate()">
                    <i class="sslm-icon sslm-icon--refresh"></i>
                    <span>{$_LANG.reissue}</span>
                </div>
                {/if}
                {if $canRenew}
                <div class="sslm-action-item" onclick="renewCertificate()">
                    <i class="sslm-icon sslm-icon--calendar"></i>
                    <span>{$_LANG.renew}</span>
                </div>
                {/if}
                {if $canCancel}
                <div class="sslm-action-item sslm-action-item--danger" onclick="cancelCertificate()">
                    <i class="sslm-icon sslm-icon--cancel"></i>
                    <span>{$_LANG.cancel}</span>
                </div>
                {/if}
            </div>
        </div>
    </div>
</div>
```

### Tasks - Phase 3:
- [ ] 3.1.1 Redesign applycert.tpl with auto-CSR default
- [ ] 3.1.2 Implement progressive form steps
- [ ] 3.2.1 Redesign complete.tpl with action buttons
- [ ] 3.2.2 Add download format selection modal
- [ ] 3.3.1 Create new manage.tpl template
- [ ] 3.4.1 Redesign message.tpl (pending status)
- [ ] 3.5.1 Create reissue.tpl (replacement for replace.tpl)
- [ ] 3.6.1 Redesign error.tpl
- [ ] 3.7.1 Create shared partials (header, footer, dcv-status)

---

## Phase 4: New Client Actions (Week 3)

### 4.1 Enhanced ActionController

**Add new methods to ActionController.php**:

```php
<?php
namespace nicsrsSSL;

class ActionController {
    // Existing methods...
    
    /**
     * New: Manage action - returns management dashboard
     */
    public static function manage(array $params): array
    {
        $order = OrderRepository::getByServiceId($params['serviceid']);
        if (!$order) {
            return ResponseFormatter::error('Order not found');
        }
        
        $configdata = json_decode($order->configdata, true);
        $status = $order->status;
        
        // Determine available actions based on status
        $actions = self::getAvailableActions($status);
        
        return [
            'success' => true,
            'data' => [
                'order' => $order,
                'configdata' => $configdata,
                'actions' => $actions,
            ]
        ];
    }
    
    /**
     * New: Reissue certificate
     */
    public static function reissue(array $params): array
    {
        $order = OrderRepository::getByServiceId($params['serviceid']);
        if (!$order) {
            return ResponseFormatter::error('Order not found');
        }
        
        if (!in_array($order->status, ['Complete', 'Issued'])) {
            return ResponseFormatter::error('Certificate must be issued to reissue');
        }
        
        $apiToken = ApiService::getApiToken($params);
        $result = ApiService::call('reissue', [
            'api_token' => $apiToken,
            'certId' => $order->remoteid,
            'params' => $_POST['params'] ?? []
        ]);
        
        if ($result->code == 1) {
            // Update order status
            OrderRepository::updateStatus($order->id, 'Reissue');
            return ResponseFormatter::success('Reissue initiated', $result->data);
        }
        
        return ResponseFormatter::error($result->msg ?? 'Reissue failed');
    }
    
    /**
     * New: Renew certificate
     */
    public static function renew(array $params): array
    {
        $order = OrderRepository::getByServiceId($params['serviceid']);
        if (!$order) {
            return ResponseFormatter::error('Order not found');
        }
        
        $apiToken = ApiService::getApiToken($params);
        $result = ApiService::call('renew', [
            'api_token' => $apiToken,
            'certId' => $order->remoteid,
        ]);
        
        if ($result->code == 1) {
            return ResponseFormatter::success('Renewal initiated', $result->data);
        }
        
        return ResponseFormatter::error($result->msg ?? 'Renewal failed');
    }
    
    /**
     * Determine available actions based on status
     */
    private static function getAvailableActions(string $status): array
    {
        $actions = [];
        
        switch ($status) {
            case 'Pending':
                $actions = ['refresh', 'updateDCV', 'cancel'];
                break;
            case 'Complete':
            case 'Issued':
                $actions = ['download', 'reissue', 'renew', 'revoke'];
                break;
            case 'Cancelled':
            case 'Revoked':
                $actions = ['view'];
                break;
            default:
                $actions = ['refresh'];
        }
        
        return $actions;
    }
}
```

### 4.2 Enhanced ActionDispatcher

**Update ActionDispatcher.php** with new routes:
```php
<?php
namespace nicsrsSSL;

class ActionDispatcher {
    private static $routes = [
        'submitApply' => 'submitApply',
        'decodeCsr' => 'decodeCsr',
        'submitReplace' => 'submitReplace',
        'downCert' => 'downCert',
        'batchUpdateDCV' => 'batchUpdateDCV',
        'cancelOrder' => 'cancelOrder',
        'refreshStatus' => 'refreshStatus',
        // New routes
        'manage' => 'manage',
        'reissue' => 'reissue',
        'renew' => 'renew',
        'revoke' => 'revoke',
        'generateCSR' => 'generateCSR',
    ];
    
    public static function dispatch(string $action, array $params): array
    {
        if (!isset(self::$routes[$action])) {
            return ResponseFormatter::error('Action not found');
        }
        
        $method = self::$routes[$action];
        return ActionController::$method($params);
    }
}
```

### 4.3 CSR Auto-Generation

**New method in CertificateFunc.php**:
```php
<?php
namespace nicsrsSSL;

class CertificateFunc {
    // Existing methods...
    
    /**
     * Generate CSR and Private Key
     */
    public static function generateCSR(array $data): array
    {
        $dn = [
            'commonName' => $data['cn'] ?? '',
            'organizationName' => $data['org'] ?? '',
            'organizationalUnitName' => $data['ou'] ?? '',
            'localityName' => $data['city'] ?? '',
            'stateOrProvinceName' => $data['state'] ?? '',
            'countryName' => $data['country'] ?? '',
            'emailAddress' => $data['email'] ?? '',
        ];
        
        // Remove empty values
        $dn = array_filter($dn);
        
        $config = [
            'private_key_bits' => 2048,
            'private_key_type' => OPENSSL_KEYTYPE_RSA,
            'digest_alg' => 'sha256',
        ];
        
        // Generate private key
        $privateKey = openssl_pkey_new($config);
        
        // Generate CSR
        $csr = openssl_csr_new($dn, $privateKey, $config);
        
        // Export CSR and private key
        openssl_csr_export($csr, $csrOut);
        openssl_pkey_export($privateKey, $privateKeyOut);
        
        return [
            'csr' => $csrOut,
            'privateKey' => $privateKeyOut,
        ];
    }
}
```

### Tasks - Phase 4:
- [ ] 4.1.1 Add manage() method to ActionController
- [ ] 4.1.2 Add reissue() method to ActionController
- [ ] 4.1.3 Add renew() method to ActionController
- [ ] 4.1.4 Add revoke() method to ActionController
- [ ] 4.2.1 Update ActionDispatcher with new routes
- [ ] 4.3.1 Implement CSR auto-generation in CertificateFunc
- [ ] 4.3.2 Add generateCSR AJAX endpoint

---

## Phase 5: WHMCS Integration & Hooks (Week 3-4)

### 5.1 Module Buttons

**Add to nicsrs_ssl.php**:
```php
function nicsrs_ssl_ClientAreaCustomButtonArray()
{
    return [
        'Manage Certificate' => 'manage',
        'Download Certificate' => 'download',
        'Refresh Status' => 'refresh',
    ];
}

function nicsrs_ssl_manage(array $params)
{
    // Redirect to management page
    return [
        'templatefile' => 'manage',
        'vars' => ActionController::manage($params),
    ];
}
```

### 5.2 Admin Area Integration

**Add Service Detail Output**:
```php
function nicsrs_ssl_AdminServicesTabFields(array $params)
{
    $order = OrderRepository::getByServiceId($params['serviceid']);
    if (!$order) {
        return [];
    }
    
    $configdata = json_decode($order->configdata, true);
    
    return [
        'Certificate ID' => $order->remoteid ?: 'N/A',
        'Status' => $order->status,
        'Domain' => $configdata['domainInfo'][0]['domainName'] ?? 'N/A',
        'Issued Date' => $configdata['applyReturn']['beginDate'] ?? 'N/A',
        'Expiry Date' => $configdata['applyReturn']['endDate'] ?? 'N/A',
    ];
}
```

### 5.3 Hook Integration

**hooks.php** - Auto-refresh status:
```php
<?php

use WHMCS\Database\Capsule;

add_hook('DailyCronJob', 1, function($vars) {
    // Auto-refresh pending certificates
    $pendingOrders = Capsule::table('nicsrs_sslorders')
        ->where('status', 'Pending')
        ->get();
    
    foreach ($pendingOrders as $order) {
        try {
            // Get API token from product or admin addon
            $service = Capsule::table('tblhosting')
                ->where('id', $order->serviceid)
                ->first();
            
            if (!$service) continue;
            
            $product = Capsule::table('tblproducts')
                ->where('id', $service->packageid)
                ->first();
            
            $apiToken = '';
            // Try product-level token first
            if (!empty($product->configoption2)) {
                $apiToken = $product->configoption2;
            } else {
                // Fallback to admin addon
                $setting = Capsule::table('mod_nicsrs_settings')
                    ->where('setting_key', 'api_token')
                    ->first();
                $apiToken = $setting->setting_value ?? '';
            }
            
            if (empty($apiToken)) continue;
            
            // Call collect API
            $result = \nicsrsSSL\ApiService::call('collect', [
                'api_token' => $apiToken,
                'certId' => $order->remoteid,
            ]);
            
            if ($result->code == 1 && $result->status == 'COMPLETE') {
                // Update order
                $configdata = json_decode($order->configdata, true);
                $configdata['applyReturn'] = array_merge(
                    $configdata['applyReturn'] ?? [],
                    (array) $result->data
                );
                
                Capsule::table('nicsrs_sslorders')
                    ->where('id', $order->id)
                    ->update([
                        'status' => 'Complete',
                        'configdata' => json_encode($configdata),
                        'completiondate' => date('Y-m-d H:i:s'),
                    ]);
            }
        } catch (\Exception $e) {
            logModuleCall('nicsrs_ssl', 'DailyCronRefresh', $order->id, $e->getMessage());
        }
    }
});
```

### Tasks - Phase 5:
- [ ] 5.1.1 Add ClientAreaCustomButtonArray function
- [ ] 5.1.2 Implement button handler functions
- [ ] 5.2.1 Add AdminServicesTabFields function
- [ ] 5.2.2 Add AdminCustomButtonArray for admin actions
- [ ] 5.3.1 Implement daily cron hook for auto-refresh
- [ ] 5.3.2 Add expiry notification hook

---

## Phase 6: Testing & Documentation (Week 4)

### 6.1 Test Cases

| Test Case | Description | Expected Result |
|-----------|-------------|-----------------|
| TC-001 | New certificate with auto-CSR | Form defaults to auto-generate, CSR created successfully |
| TC-002 | New certificate with manual CSR | CSR textarea shown, submission works |
| TC-003 | DV certificate application | Only domain validation shown |
| TC-004 | OV/EV certificate application | Organization info required |
| TC-005 | Multi-domain certificate | Add/remove domains works |
| TC-006 | Certificate download | All formats download correctly |
| TC-007 | Certificate reissue | Reissue form shown, API called |
| TC-008 | Status refresh | Status updated from API |
| TC-009 | Shared API token | Falls back to admin addon token |
| TC-010 | Vietnamese language | All strings translated |

### 6.2 Backward Compatibility

**Migration Path**:
1. Existing orders with old UI continue to work
2. No database schema changes
3. API token fallback ensures existing products work
4. Service aliases for renamed classes

**Alias file (compatibility.php)**:
```php
<?php
// Backward compatibility aliases
namespace nicsrsSSL;

class_alias('nicsrsSSL\\ApiService', 'nicsrsSSL\\nicsrsAPI');
class_alias('nicsrsSSL\\CertificateFunc', 'nicsrsSSL\\nicsrsFunc');
class_alias('nicsrsSSL\\ResponseFormatter', 'nicsrsSSL\\nicsrsResponse');
class_alias('nicsrsSSL\\OrderRepository', 'nicsrsSSL\\nicsrsSSLSql');
class_alias('nicsrsSSL\\TemplateHelper', 'nicsrsSSL\\nicsrsTemplate');
```

### Tasks - Phase 6:
- [ ] 6.1.1 Execute all test cases
- [ ] 6.1.2 Fix identified issues
- [ ] 6.2.1 Create compatibility.php for class aliases
- [ ] 6.2.2 Test with existing installations
- [ ] 6.3.1 Update README.md
- [ ] 6.3.2 Create CHANGELOG.md for v2.0.0
- [ ] 6.3.3 Create UPGRADE.md migration guide

---

## Implementation Checklist

### Week 1: Foundation
- [ ] Set up development environment
- [ ] Create ApiService.php with shared token
- [ ] Rename service files with aliases
- [ ] Add Vietnamese translations
- [ ] Create base CSS framework

### Week 2: UI Modernization  
- [ ] Complete ssl-manager.css
- [ ] Create ssl-manager.js
- [ ] Redesign applycert.tpl
- [ ] Implement auto-CSR generation
- [ ] Create form validation JS

### Week 3: Features & Actions
- [ ] Redesign complete.tpl
- [ ] Create manage.tpl
- [ ] Implement reissue/renew actions
- [ ] Add WHMCS button integration
- [ ] Create pending.tpl

### Week 4: Testing & Polish
- [ ] Execute test cases
- [ ] Fix bugs
- [ ] Performance optimization
- [ ] Documentation
- [ ] Release preparation

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Breaking existing installations | High | Class aliases, no DB changes |
| API compatibility | Medium | Shared token fallback |
| UI inconsistency with WHMCS themes | Medium | Use CSS variables, test with default themes |
| Language file completeness | Low | Review all strings before release |

---

## Success Criteria

1. ✅ All existing functionality preserved
2. ✅ UI consistent with Admin Addon module
3. ✅ No "NicSRS" branding in public assets
4. ✅ Auto-CSR generation as default option
5. ✅ All new actions (manage, reissue, renew) working
6. ✅ Shared API token from Admin Addon
7. ✅ Vietnamese language support complete
8. ✅ Zero breaking changes for existing customers

---

## Appendix A: File Mapping (Old → New)

| Old File | New File | Action |
|----------|----------|--------|
| `nicsrs_ssl.php` | `nicsrs_ssl.php` | Enhance |
| `hooks.php` | `hooks.php` | Enhance |
| `src/model/Service/nicsrsAPI.php` | `src/model/Service/ApiService.php` | Rename + Enhance |
| `src/model/Service/nicsrsFunc.php` | `src/model/Service/CertificateFunc.php` | Rename + Enhance |
| `src/model/Service/nicsrsResponse.php` | `src/model/Service/ResponseFormatter.php` | Rename |
| `src/model/Service/nicsrsSSLSql.php` | `src/model/Service/OrderRepository.php` | Rename |
| `src/model/Service/nicsrsTemplate.php` | `src/model/Service/TemplateHelper.php` | Rename + Enhance |
| `view/home/` | `assets/` | Rename + Rebrand |
| `view/home/css/style.css` | `assets/css/ssl-manager.css` | Complete Redesign |
| `view/home/js/common.js` | `assets/js/ssl-manager.js` | Complete Redesign |
| `view/applycert.tpl` | `view/applycert.tpl` | Complete Redesign |
| `view/complete.tpl` | `view/complete.tpl` | Complete Redesign |
| `view/message.tpl` | `view/message.tpl` | Complete Redesign |
| `view/replace.tpl` | `view/reissue.tpl` | Rename + Redesign |
| N/A | `view/manage.tpl` | New |
| N/A | `view/pending.tpl` | New |
| N/A | `view/partials/` | New |
| `lang/english.php` | `lang/english.php` | Enhance |
| N/A | `lang/vietnamese.php` | New |

---

## Appendix B: CSS Class Renaming Map

| Old Class | New Class |
|-----------|-----------|
| `.nicsrs-container` | `.sslm-container` |
| `.nicsrs-card` | `.sslm-card` |
| `.nicsrs-btn` | `.sslm-btn` |
| `.nicsrs-input` | `.sslm-input` |
| `.nicsrs-table` | `.sslm-table` |
| `.nicsrs-badge` | `.sslm-badge` |
| `.nicsrs-form` | `.sslm-form` |
| `.nicsrs-alert` | `.sslm-alert` |
| `.nicsrs-modal` | `.sslm-modal` |
| `.nicsrs-step` | `.sslm-step` |
| `.nicsrs-icon` | `.sslm-icon` |

---

## Appendix C: New Language Strings

```php
// english.php additions
$_LANG['ssl_management'] = 'SSL Management';
$_LANG['configure_certificate'] = 'Configure Certificate';
$_LANG['auto_generate_csr'] = 'Auto-generate CSR';
$_LANG['manual_csr'] = 'Enter CSR manually';
$_LANG['common_name'] = 'Common Name (Domain)';
$_LANG['organization'] = 'Organization';
$_LANG['organizational_unit'] = 'Organizational Unit';
$_LANG['city'] = 'City';
$_LANG['state'] = 'State/Province';
$_LANG['country'] = 'Country';
$_LANG['step_csr'] = 'CSR';
$_LANG['step_domain'] = 'Domain Validation';
$_LANG['step_contacts'] = 'Contacts';
$_LANG['save_draft'] = 'Save Draft';
$_LANG['submit_request'] = 'Submit Request';
$_LANG['download_certificate'] = 'Download Certificate';
$_LANG['reissue'] = 'Reissue';
$_LANG['renew'] = 'Renew';
$_LANG['revoke'] = 'Revoke';
$_LANG['manage_certificate'] = 'Manage Certificate';
$_LANG['refresh_status'] = 'Refresh Status';
$_LANG['certificate_issued'] = 'Certificate Issued';
$_LANG['certificate_pending'] = 'Certificate Pending';
$_LANG['domain_validation_required'] = 'Domain Validation Required';
$_LANG['select_download_format'] = 'Select Download Format';
$_LANG['format_apache'] = 'Apache (.crt + .ca-bundle)';
$_LANG['format_nginx'] = 'Nginx (.pem)';
$_LANG['format_iis'] = 'IIS (.p12)';
$_LANG['format_tomcat'] = 'Tomcat (.jks)';
$_LANG['all_formats'] = 'All Formats (ZIP)';
```

---

**Document Version**: 1.0  
**Last Updated**: January 2026  
**Author**: HVN GROUP